//
// This file is part of AtomVM.
//
// Copyright 2026 Paul Guyot <pguyot@kallisys.net>
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//    http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
// SPDX-License-Identifier: Apache-2.0 OR LGPL-2.1-or-later
//

using "platforms/cpus/stm32g0.repl"

flash:
    size: 0x80000

ram:
    size: 0x24000

rcc:
    script: '''
if request.IsInit:
    lastVal = 0
    regs = {}
    data = {'hsion': 1, 'hseon': 0, 'pllon': 0, 'sw': 0, 'lsion': 0}

if request.IsWrite:
    regs[request.Offset] = request.Value
    if request.Offset == 0x0:
        data['hsion'] = (request.Value >> 8) & 0x1
        data['hseon'] = (request.Value >> 16) & 0x1
        data['pllon'] = (request.Value >> 24) & 0x1
    elif request.Offset == 0x8:
        data['sw'] = request.Value & 0x7
    elif request.Offset == 0x60:
        data['lsion'] = request.Value & 0x1
elif request.IsRead:
    lastVal = 1 - lastVal
    if request.Offset == 0x0:
        request.Value = (data['hsion'] << 8) | (data['hsion'] << 10) | (data['hseon'] << 16) | (data['hseon'] << 17) | (data['pllon'] << 24) | (data['pllon'] << 25)
    elif request.Offset == 0x4:
        request.Value = lastVal * 0xFFFFFFF8
    elif request.Offset == 0x8:
        request.Value = (regs.get(0x8, 0) & ~0x38) | (data['sw'] << 3)
    elif request.Offset == 0x24:
        request.Value = 0x0
    elif request.Offset == 0x60:
        request.Value = (data['lsion'] << 1)
    else:
        request.Value = regs.get(request.Offset, 0)
'''
